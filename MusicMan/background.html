<html>
 <!--
 	@title  MusicMan
 	@author Jean-Lou Dupont
 	@desc   Music Manager for music web-sites
 	
  -->
	<head>
		<script src="oo.js"></script>
		<script src="util.js"></script>
		<script src="ws.js"></script>
		<script src="pubnub.js"></script>
		<script src="scheduler.js"></script>

		<script>
			// Port tab id of the current player
			//  i.e. the tab where the 'current_*' updates are coming from
			var current_player_tabid=null;
			var ports={};
			var _debug=false;
			var ws=null;
			var sc=new Scheduler();
			
			// web-socket state
			var ws_state=false;

			// PubNub state
			var pn_state=false;
			
			

// ====================================================================================
			
			var onOpen=function() {
				if (_debug)
					console.log("onOpen");
				
				ws_state=true;
				sc.push_task("onOpen", displayConnectionStatus);
			};
			var onClose=function(wasOpen) {
				
				ws_state=false;
				if (wasOpen)
					sc.push_task("onClose", displayConnectionStatus);
				
				if (_debug)
					console.log("onClose");
				ws=null;
			};

			var onError=function(){
				console.log("onError");
			};
			
			var onMsg=function(str_msg){
				console.log("onMsg: str_msg: "+str_msg);
				var msg=JSON.parse(str_msg);

				if (msg.mtype!='mk_key_press')
					return;
				
				sc.push_task("Send to tab", function(){
					sendMsgToTab(current_player_tabid, {'mtype': msg.key});
				}, null);
				
			};

// ==================================================================
//
	
			/**
			*  UPDATE browser-action area based on:
		    *  - web-socket state
		    *  - pubnub-state
		    *
			*/
			var displayConnectionStatus=function(scheduler) {
				
				var msg=isOpen ? "OK":":(";
				//console.log("displayConnectionStatus: "+msg);
				chrome.browserAction.setBadgeText({"text":msg});

				var title=isOpen ? "MediaKeys Server OK":"MediaKeys Server not found :(";
				chrome.browserAction.setTitle({"title": "Music Man - "+title});
			};
			
			var ManageConnection=function() {
				if (ws==null)
					if (_debug)
						console.log("ManageConnection: ws is null");
				
				if ((ws==null) || !(ws.isConnected())) {
					ws=new WS(onOpen, onMsg, onClose, onError, _debug);
					ws.connect();					
				};
			};

			var EnsureConnection=function(scheduler, param) {
				//console.log("EnsureConnection: begin");
				ManageConnection();
				//console.log("EnsureConnection: end");
			};

			setInterval(function(){
				sc.exec_stack();				
				sc.push_task("EnsureConnection", EnsureConnection, null);	
			}, 500);

			
// EXTENSION MESSAGING
// -------------------
			
			var sendMsgToTab=function(tabid, msg) {
				//console.log("SendMsgToTab: tabid("+tabid+"): "+msg.mtype);
				if (tabid==undefined || tabid==null) {
					console.warn("SendMsgToTab: tabid invalid");
					return;
				}
				chrome.tabs.sendRequest(tabid, msg, function(response) {
				});
			};

			function doSendStatus(sendResponse) {
				sendResponse({
					mtype: "status"
					,data: "unknown"
				});
			};
			
			function handle_config_message(msg, sendResponse) {

				if (msg.mtype=="status?") {
					doSendStatus(sendResponse);
					return;
				}
				
				console.log("config message: ");
				console.log(msg);
			};
			
			/*
			 *  Messages from:
			 *	- content scripts
			 *    'current_*' : [track|state]
			 *
			 *  - config page
			 *    'status?'
			 * 
			 *   
			 */
			chrome.extension.onRequest.addListener(function(msg, sender, sendResponse) {
				var sender_tab=sender.tab || null;

				if (!sender_tab) {
					// probably from the config.html page...
					handle_config_message(msg, sendResponse);
					return;
				}//
				
				var sender_tab_id=sender.tab.id;
				var mtype=msg.mtype;

				if (!strStartsWith(mtype, "current")) {
					return;
				};

				console.log("From tab("+sender_tab_id+"): "+msg.mtype);
				
				if (sender_tab_id!=current_player_tabid) {
					current_player_tabid=sender_tab_id;
					console.log("New current player: "+sender_tab_id); 
					};
			});

			/* 
			 *  Content scripts connect through here
			 *   Keep a reference to the tabs we can interact with
			 */
			chrome.extension.onConnect.addListener(function(port) {
		    	var tid    = port.tab.id;
		    	//var url    = port.tab.url;

		    	ports[tid]=null;
			});
			
		</script>
	</head>
</html>