<html>
 <!--
 	@title  MusicMan
 	@author Jean-Lou Dupont
 	@desc   Music Manager for music web-sites
 	
  -->
	<head>
		<script src="oo.js"></script>
		<script src="ws.js"></script>
		<script src="scheduler.js"></script>

		<script>
			// Port tab id of the current player
			//  i.e. the tab where the 'current_*' updates are coming from
			var current_player_tabid=null;
			var ports={};
			var _debug=true;
			var ws=null;
			//var sc=new Scheduler(_debug);
			var sc=new Scheduler();
			
			var onOpen=function() {
				console.log("onOpen");
			};
			var onClose=function() {
				console.log("onClose");
				ws=null;
			};
			var onMsg=function(msg){
				console.log(msg);
			};
			
			var ManageConnection=function() {
				if (ws==null)
					console.log("ManageConnection: ws is null");
				
				if ((ws==null) || !(ws.isConnected())) {
					ws=new WS(onOpen, onMsg, onClose, _debug);
					ws.connect();					
				};
			};

			var EnsureConnection=function(scheduler, param) {
				//console.log("EnsureConnection: begin");
				ManageConnection();
				//console.log("EnsureConnection: end");
			};

			setInterval(function(){
				sc.push_task("EnsureConnection", EnsureConnection, null);	
				sc.exec_stack();
			}, 500);

			/**
			 *  Messages from content scripts 
			 *  'current_*' : [track|state]
			 *   
			 */
			chrome.extension.onRequest.addListener(function(msg, sender, sendResponse) {
				var sender_tab_id=sender.tab.id;
				var mtype=msg.mtype;

				if (!strStartsWith(mtype, "current")) {
					return;
				};

				if (sender_tab_id!=current_player_tabid) {
					current_player_tabid=sender_tab_id;
					console.log("New current player: "+sender_tab_id;); 
					};
								
				//console.log("mtype: "+msg.mtype);
				//console.log(msg);
			});

			/* 
			 *  Content scripts connect through here
			 *   Keep a reference to the tabs we can interact with
			 */
			chrome.extension.onConnect.addListener(function(port) {
		    	var tid    = port.tab.id;
		    	//var url    = port.tab.url;

		    	ports[tid]=null;
			});
			
		</script>
	</head>
</html>